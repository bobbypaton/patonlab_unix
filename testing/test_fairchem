#!/usr/bin/env python3

"""
Simple test script to verify FairChem MLIP models are working.
Calculates the single-point energy of a water molecule using both
the eSEN and UMA-small models.

Usage:
    python test_fairchem_water.py
    python test_fairchem_water.py --device cpu  # Force CPU inference
"""

import os
import sys

# Set environment variables before importing fairchem
os.environ['OMP_NUM_THREADS'] = '1'
os.environ['MKL_NUM_THREADS'] = '1'
os.environ['JAX_PLATFORMS'] = 'cpu'

from ase import Atoms
from fairchem.core import FAIRChemCalculator
from fairchem.core.units.mlip_unit import load_predict_unit

# Model configuration - adjust this path to where your models are stored
MODEL_DIR = "/usr/local/fairchem_models"

# Conversion factor
HARTREE_TO_EV = 27.211386245988


def create_water_molecule():
    """
    Creates a water molecule (H2O) with reasonable geometry.
    O-H bond length: ~0.96 Å, H-O-H angle: ~104.5°
    """
    # Water molecule coordinates (Angstroms)
    positions = [
        [0.0000, 0.0000, 0.1173],   # O
        [0.0000, 0.7572, -0.4692],  # H
        [0.0000, -0.7572, -0.4692], # H
    ]

    water = Atoms(
        symbols='OHH',
        positions=positions,
        info={'charge': 0, 'spin': 1}  # neutral singlet
    )

    return water


def test_model(model_name, model_file, device='cuda'):
    """
    Test a single MLIP model by calculating water energy.

    Returns:
        energy in Hartree, or None if failed
    """
    model_path = os.path.join(MODEL_DIR, model_file)

    print(f"\n{'='*50}")
    print(f"Testing {model_name} model")
    print(f"{'='*50}")
    print(f"Model path: {model_path}")

    # Check if model file exists
    if not os.path.exists(model_path):
        print(f"ERROR: Model file not found at {model_path}")
        return None

    try:
        # Load the model
        print(f"Loading model on device: {device}")
        predictor = load_predict_unit(path=model_path, device=device)
        print("Model loaded successfully!")

        # Create water molecule
        water = create_water_molecule()
        print(f"Created water molecule with {len(water)} atoms")

        # Attach calculator
        water.calc = FAIRChemCalculator(predictor, task_name="omol")

        # Calculate energy
        energy_ev = water.get_potential_energy()
        energy_hartree = energy_ev / HARTREE_TO_EV

        print(f"\nResults:")
        print(f"  Energy: {energy_ev:.6f} eV")
        print(f"  Energy: {energy_hartree:.8f} Hartree")

        # Also get forces to verify gradients work
        forces = water.get_forces()
        max_force = abs(forces).max()
        print(f"  Max force: {max_force:.6f} eV/Å")

        return energy_hartree

    except Exception as e:
        print(f"ERROR: {e}")
        import traceback
        traceback.print_exc()
        return None


def main():
    # Parse device argument
    device = 'cuda'
    if '--device' in sys.argv:
        idx = sys.argv.index('--device')
        if idx + 1 < len(sys.argv):
            device = sys.argv[idx + 1]

    # Also accept --cpu shorthand
    if '--cpu' in sys.argv:
        device = 'cpu'

    print("FairChem MLIP Model Test")
    print("=" * 50)
    print(f"Testing with device: {device}")
    print(f"Model directory: {MODEL_DIR}")

    # Test both models
    models = [
        ("eSEN", "esen_sm_conserving_all.pt"),
        ("UMA-small", "uma-s-1p1.pt"),
    ]

    results = {}
    for model_name, model_file in models:
        energy = test_model(model_name, model_file, device=device)
        results[model_name] = energy

    # Summary
    print(f"\n{'='*50}")
    print("SUMMARY")
    print(f"{'='*50}")

    all_passed = True
    for model_name, energy in results.items():
        if energy is not None:
            print(f"  {model_name}: {energy:.8f} Ha ✓")
        else:
            print(f"  {model_name}: FAILED ✗")
            all_passed = False

    # Compare energies if both succeeded
    if all(e is not None for e in results.values()):
        diff = abs(results["eSEN"] - results["UMA-small"])
        print(f"\n  Energy difference: {diff:.8f} Ha ({diff * HARTREE_TO_EV:.6f} eV)")

    print()
    if all_passed:
        print("All tests PASSED!")
        return 0
    else:
        print("Some tests FAILED!")
        return 1


if __name__ == "__main__":
    sys.exit(main())
